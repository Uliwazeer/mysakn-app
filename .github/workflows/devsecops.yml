name: DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Auth Service Image
      uses: docker/build-push-action@v4
      with:
        context: ./services/auth-service
        push: false
        tags: auth-service:${{ github.sha }}

    - name: Build Housing Service Image
      uses: docker/build-push-action@v4
      with:
        context: ./services/housing-service
        push: false
        tags: housing-service:${{ github.sha }}

    # Security Scanning with Trivy
    - name: Run Trivy Vulnerability Scanner (Auth Service)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'auth-service:${{ github.sha }}'
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

    - name: Run Trivy Vulnerability Scanner (Housing Service)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'housing-service:${{ github.sha }}'
        format: 'table'
        exit-code: '0' # Don't fail for now, just report
        severity: 'CRITICAL,HIGH'

    # Validating K8s Manifests
    - name: Kubeval - Validate K8s Manifests
      uses: instrumenta/kubeval-action@master
      with:
        files: k8s/*.yaml
